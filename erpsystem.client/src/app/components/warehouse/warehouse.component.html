<head>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<div class="warehouse-container">
  <div class="dashboard-container">
    <aside class="sidebar">
      <h2>Dashboard</h2>
      <ul>
        <li><a href="#">üìä Statystyki</a></li>
        <li><button (click)="goToWarehouse()">üì¶ Magazyn</button></li>
        <li><button (click)="showReport('stock')">üìã Stan magazynowy</button></li>
        <li><button (click)="showReport('movements')">üìÖ Ruchy w okresie</button></li>
        <li><button (click)="showReport('popular')">‚≠ê Najpopularniejsze</button></li>
        <li><a href="#">üìÑ Faktury</a></li>
        <li><a href="#">üë§ Klienci</a></li>
        <li><a href="#">‚öôÔ∏è Ustawienia</a></li>
        <li><button (click)="logout()">üö™ Wyloguj</button></li>
      </ul>
    </aside>

    <main class="main-content">
      <header>
        <div>
          <h1>Witaj w systemie ERP</h1>
          <p>ZarzƒÖdzaj danymi w jednym miejscu</p>
        </div>
        <div class="user-info">
          <p>Zalogowany jako: <strong>{{ currentUserEmail || 'Brak danych u≈ºytkownika' }}</strong></p>
        </div>
      </header>
      <section class="warehouse-section">
        <div class="messages">
          <div class="alert alert-success" *ngIf="successMessage">{{ successMessage }}</div>
          <div class="alert alert-danger" *ngIf="errorMessage">{{ errorMessage }}</div>
          <div class="alert low-stock-alert" *ngFor="let notification of notifications">{{ notification }}</div>
        </div>
        <div class="forms-container" *ngIf="showAddForm">
          <div class="add-item-form">
            <h3>Dodaj nowy produkt</h3>
            <form>
              <div class="form-grid">
                <div class="form-group">
                  <label for="name">Nazwa</label>
                  <input [(ngModel)]="newItem.name" id="name" placeholder="Nazwa" name="name" required>
                </div>
                <div class="form-group">
                  <label for="code">Kod</label>
                  <input [(ngModel)]="newItem.code" id="code" placeholder="Kod" name="code" required>
                </div>
                <div class="form-group">
                  <label for="quantity">Ilo≈õƒá</label>
                  <input [(ngModel)]="newItem.quantity" id="quantity" type="number" placeholder="Ilo≈õƒá" name="quantity" required min="0" (ngModelChange)="syncMovementQuantity()">
                </div>
                <div class="form-group">
                  <label for="price">Cena</label>
                  <input [(ngModel)]="newItem.price" id="price" type="number" placeholder="Cena" name="price" required min="0" step="0.01">
                </div>
                <div class="form-group">
                  <label for="category">Kategoria</label>
                  <input [(ngModel)]="newItem.category" id="category" placeholder="Kategoria" name="category" required>
                </div>
                <div class="form-group">
                  <label for="location">Lokalizacja</label>
                  <select [(ngModel)]="newItem.location" id="location" name="location" required>
                    <option value="" disabled>Wybierz lokalizacjƒô</option>
                    <option *ngFor="let loc of availableLocations" [value]="loc.name">{{ loc.name }}</option>
                  </select>
                </div>
              </div>
              <div class="movement-section">
                <h4>Pierwsze przyjƒôcie</h4>
                <div class="form-grid">
                  <div class="form-group">
                    <label for="movementType">Typ ruchu</label>
                    <select [(ngModel)]="newMovement.movementType" id="movementType" name="movementType" required>
                      <option value="Przyjƒôcie zewnƒôtrzne">Przyjƒôcie zewnƒôtrzne</option>
                      <option value="Przyjƒôcie wewnƒôtrzne">Przyjƒôcie wewnƒôtrzne</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="supplier">Dostawca</label>
                    <input [(ngModel)]="newMovement.supplier" id="supplier" placeholder="Dostawca" name="supplier" required>
                  </div>
                  <div class="form-group">
                    <label for="documentNumber">Numer dokumentu</label>
                    <input [(ngModel)]="newMovement.documentNumber" id="documentNumber" placeholder="Numer dokumentu (np. PZ)" name="documentNumber" required>
                  </div>
                </div>
                <div class="form-group full-width">
                  <label for="description">Opis przyjƒôcia</label>
                  <textarea [(ngModel)]="newMovement.description" id="description" placeholder="Opis przyjƒôcia" name="description"></textarea>
                </div>
              </div>
              <div class="form-buttons">
                <button type="button" (click)="addItemWithMovement()">Dodaj produkt i ruch</button>
                <button type="button" class="cancel-button" (click)="toggleAddForm()">Anuluj</button>
              </div>
            </form>
          </div>
        </div>
        <div class="forms-container" *ngIf="editItem">
          <div class="edit-item-form">
            <h3>Edytuj produkt</h3>
            <form>
              <input [(ngModel)]="editItem.name" placeholder="Nazwa" name="name" required>
              <input [(ngModel)]="editItem.code" placeholder="Kod" name="code" required>
              <input [(ngModel)]="editItem.quantity" type="number" placeholder="Ilo≈õƒá" name="quantity" required>
              <input [(ngModel)]="editItem.price" type="number" placeholder="Cena" name="price" required>
              <input [(ngModel)]="editItem.category" placeholder="Kategoria" name="category" required>
              <select [(ngModel)]="editItem.location" name="location" required>
                <option value="" disabled>Wybierz lokalizacjƒô</option>
                <option *ngFor="let loc of availableLocations" [value]="loc.name">{{ loc.name }}</option>
              </select>
              <div class="form-buttons">
                <button type="button" (click)="updateItem()">Zapisz</button>
                <button type="button" class="cancel-button" (click)="cancelEdit()">Anuluj</button>
              </div>
            </form>
          </div>
        </div>
        <div class="items-list">
          <div class="list-controls">
            <button class="add-button" (click)="toggleAddForm()">Dodaj produkt</button>
            <button class="toggle-deleted" (click)="toggleDeletedView()">
              {{ showDeleted ? "Poka≈º aktywne" : "Poka≈º usuniƒôte" }}
            </button>
            <button class="toggle-history" (click)="toggleHistoryView()">
              {{ showHistory ? "Ukryj historiƒô" : "Poka≈º historiƒô" }}
            </button>
          </div>
          <div class="advanced-filters">
            <input [(ngModel)]="nameFilter" placeholder="Szukaj po nazwie lub kodzie" (ngModelChange)="applyFilters()">
            <select [(ngModel)]="categoryFilter" (ngModelChange)="applyFilters()">
              <option value="">Wszystkie kategorie</option>
              <option *ngFor="let category of uniqueCategories" [value]="category">{{ category }}</option>
            </select>
            <select [(ngModel)]="locationFilter" (ngModelChange)="applyFilters()">
              <option value="">Wszystkie lokalizacje</option>
              <option *ngFor="let loc of availableLocations" [value]="loc.name">{{ loc.name }}</option>
            </select>
            <label>Ilo≈õƒá: {{ minQuantityFilter || 0 }} - {{ maxQuantityFilter || maxQuantity }}</label>
            <input type="range" [(ngModel)]="minQuantityFilter" [min]="0" [max]="maxQuantity" (ngModelChange)="applyFilters()">
            <input type="range" [(ngModel)]="maxQuantityFilter" [min]="0" [max]="maxQuantity" (ngModelChange)="applyFilters()">
            <label><input type="checkbox" [(ngModel)]="lowStockFilter" (ngModelChange)="applyFilters()"> Tylko niski stan</label>
          </div>
          <table>
            <thead>
              <tr>
                <th (click)="sortItems('name')">Nazwa <span [ngClass]="{'sort-asc': sortField === 'name' && sortDirection === 'asc', 'sort-desc': sortField === 'name' && sortDirection === 'desc'}"></span></th>
                <th (click)="sortItems('code')">Kod <span [ngClass]="{'sort-asc': sortField === 'code' && sortDirection === 'asc', 'sort-desc': sortField === 'code' && sortDirection === 'desc'}"></span></th>
                <th (click)="sortItems('quantity')">Ilo≈õƒá <span [ngClass]="{'sort-asc': sortField === 'quantity' && sortDirection === 'asc', 'sort-desc': sortField === 'quantity' && sortDirection === 'desc'}"></span></th>
                <th (click)="sortItems('price')">Cena <span [ngClass]="{'sort-asc': sortField === 'price' && sortDirection === 'asc', 'sort-desc': sortField === 'price' && sortDirection === 'desc'}"></span></th>
                <th (click)="sortItems('category')">Kategoria <span [ngClass]="{'sort-asc': sortField === 'category' && sortDirection === 'asc', 'sort-desc': sortField === 'category' && sortDirection === 'desc'}"></span></th>
                <th (click)="sortItems('location')">Lokalizacja <span [ngClass]="{'sort-asc': sortField === 'location' && sortDirection === 'asc', 'sort-desc': sortField === 'location' && sortDirection === 'desc'}"></span></th>
                <th (click)="sortItems('lastMovementDate')">Ostatni ruch <span [ngClass]="{'sort-asc': sortField === 'lastMovementDate' && sortDirection === 'asc', 'sort-desc': sortField === 'lastMovementDate' && sortDirection === 'desc'}"></span></th>
                <th (click)="sortItems('movementFrequency')">Czƒôstotliwo≈õƒá ruch√≥w <span [ngClass]="{'sort-asc': sortField === 'movementFrequency' && sortDirection === 'asc', 'sort-desc': sortField === 'movementFrequency' && sortDirection === 'desc'}"></span></th>
                <th>Akcje</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of filteredItems">
                <td data-label="Nazwa">{{ item.name }}</td>
                <td data-label="Kod">{{ item.code }}</td>
                <td data-label="Ilo≈õƒá">{{ item.quantity }}</td>
                <td data-label="Cena">{{ item.price }}</td>
                <td data-label="Kategoria">{{ item.category }}</td>
                <td data-label="Lokalizacja">{{ item.location }}</td>
                <td data-label="Ostatni ruch">{{ item.lastMovementDate }}</td>
                <td data-label="Czƒôstotliwo≈õƒá ruch√≥w">{{ item.movementFrequency }}</td>
                <td data-label="Akcje" class="actions">
                  <button *ngIf="!showDeleted" class="action-button edit-button" (click)="startEdit(item)">Edytuj</button>
                  <button *ngIf="!showDeleted" class="action-button delete-button" (click)="deleteItem(item.id)">Usu≈Ñ</button>
                  <button *ngIf="showDeleted" class="action-button restore-button" (click)="restoreItem(item.id)">Przywr√≥ƒá</button>
                  <button *ngIf="!showDeleted" class="action-button" (click)="toggleMovements(item.id)">
                    {{ showMovements && selectedItemId === item.id ? "Ukryj ruchy" : "Ruchy magazynowe" }}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="movements-container" *ngIf="showMovements && selectedItemId">
            <form>
              <select [(ngModel)]="newMovement.movementType" name="movementType" required>
                <option value="Przyjƒôcie zewnƒôtrzne">Przyjƒôcie zewnƒôtrzne</option>
                <option value="Przyjƒôcie wewnƒôtrzne">Przyjƒôcie wewnƒôtrzne</option>
                <option value="Wydanie">Wydanie</option>
              </select>
              <select [(ngModel)]="newMovement.status" name="status" required>
                <option value="Zaplanowane">Zaplanowane</option>
                <option value="W trakcie">W trakcie</option>
                <option value="Zako≈Ñczone">Zako≈Ñczone</option>
              </select>
              <input [(ngModel)]="newMovement.quantity" type="number" placeholder="Ilo≈õƒá" name="quantity" required min="1">
              <input [(ngModel)]="newMovement.supplier" placeholder="Dostawca" name="supplier">
              <input [(ngModel)]="newMovement.documentNumber" placeholder="Numer dokumentu" name="documentNumber">
              <textarea [(ngModel)]="newMovement.description" placeholder="Opis" name="description"></textarea>
              <textarea [(ngModel)]="newMovement.comment" placeholder="Komentarz" name="comment"></textarea>
              <button type="button" (click)="addMovement()">Dodaj ruch</button>
            </form>
            <h4>Ruchy magazynowe</h4>
            <table>
              <thead>
                <tr>
                  <th (click)="sortMovements('movementType')">Typ <span [ngClass]="{'sort-asc': movementSortField === 'movementType' && movementSortDirection === 'asc', 'sort-desc': movementSortField === 'movementType' && movementSortDirection === 'desc'}"></span></th>
                  <th (click)="sortMovements('status')">Status <span [ngClass]="{'sort-asc': movementSortField === 'status' && movementSortDirection === 'asc', 'sort-desc': movementSortField === 'status' && movementSortDirection === 'desc'}"></span></th>
                  <th (click)="sortMovements('quantity')">Ilo≈õƒá <span [ngClass]="{'sort-asc': movementSortField === 'quantity' && movementSortDirection === 'asc', 'sort-desc': movementSortField === 'quantity' && movementSortDirection === 'desc'}"></span></th>
                  <th (click)="sortMovements('supplier')">Dostawca <span [ngClass]="{'sort-asc': movementSortField === 'supplier' && movementSortDirection === 'asc', 'sort-desc': movementSortField === 'supplier' && movementSortDirection === 'desc'}"></span></th>
                  <th (click)="sortMovements('documentNumber')">Numer dokumentu <span [ngClass]="{'sort-asc': movementSortField === 'documentNumber' && movementSortDirection === 'asc', 'sort-desc': movementSortField === 'documentNumber' && movementSortDirection === 'desc'}"></span></th>
                  <th (click)="sortMovements('date')">Data <span [ngClass]="{'sort-asc': movementSortField === 'date' && movementSortDirection === 'asc', 'sort-desc': movementSortField === 'date' && movementSortDirection === 'desc'}"></span></th>
                  <th (click)="sortMovements('description')">Opis <span [ngClass]="{'sort-asc': movementSortField === 'description' && movementSortDirection === 'asc', 'sort-desc': movementSortField === 'description' && movementSortDirection === 'desc'}"></span></th>
                  <th (click)="sortMovements('comment')">Komentarz <span [ngClass]="{'sort-asc': movementSortField === 'comment' && movementSortDirection === 'asc', 'sort-desc': movementSortField === 'comment' && movementSortDirection === 'desc'}"></span></th>
                  <th (click)="sortMovements('createdBy')">U≈ºytkownik <span [ngClass]="{'sort-asc': movementSortField === 'createdBy' && movementSortDirection === 'asc', 'sort-desc': movementSortField === 'createdBy' && movementSortDirection === 'desc'}"></span></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let m of filteredMovements">
                  <td data-label="Typ">{{ m.movementType }}</td>
                  <td data-label="Status">{{ m.status }}</td>
                  <td data-label="Ilo≈õƒá">{{ m.quantity }}</td>
                  <td data-label="Dostawca">{{ m.supplier }}</td>
                  <td data-label="Numer dokumentu">{{ m.documentNumber }}</td>
                  <td data-label="Data">{{ m.date }}</td>
                  <td data-label="Opis">{{ m.description }}</td>
                  <td data-label="Komentarz">{{ m.comment }}</td>
                  <td data-label="U≈ºytkownik">{{ m.createdBy }}</td>
                </tr>
              </tbody>
            </table>
            <div>
              <h3>Masowe dodawanie ruch√≥w z CSV</h3>
              <input type="file" (change)="onFileChange($event)" accept=".csv">
            </div>
          </div>
        </div>
        <div class="history-section" *ngIf="showHistory">
          <div class="history-filters">
            <input [(ngModel)]="historyUserFilter" placeholder="Filtruj po u≈ºytkowniku" (ngModelChange)="applyHistoryFilters()">
            <input [(ngModel)]="historyStartDateFilter" type="date" placeholder="Od daty" (ngModelChange)="applyHistoryFilters()">
            <input [(ngModel)]="historyEndDateFilter" type="date" placeholder="Do daty" (ngModelChange)="applyHistoryFilters()">
            <input [(ngModel)]="historyItemFilter" placeholder="Filtruj po produkcie" (ngModelChange)="applyHistoryFilters()">
          </div>
          <table>
            <thead>
              <tr>
                <th (click)="sortHistory('user')">U≈ºytkownik <span [ngClass]="{'sort-asc': historySortField === 'user' && historySortDirection === 'asc', 'sort-desc': historySortField === 'user' && historySortDirection === 'desc'}"></span></th>
                <th (click)="sortHistory('operation')">Operacja <span [ngClass]="{'sort-asc': historySortField === 'operation' && historySortDirection === 'asc', 'sort-desc': historySortField === 'operation' && historySortDirection === 'desc'}"></span></th>
                <th (click)="sortHistory('itemName')">Produkt <span [ngClass]="{'sort-asc': historySortField === 'itemName' && historySortDirection === 'asc', 'sort-desc': historySortField === 'itemName' && historySortDirection === 'desc'}"></span></th>
                <th (click)="sortHistory('timestamp')">Data <span [ngClass]="{'sort-asc': historySortField === 'timestamp' && historySortDirection === 'asc', 'sort-desc': historySortField === 'timestamp' && historySortDirection === 'desc'}"></span></th>
                <th>Szczeg√≥≈Çy</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let log of filteredOperationLogs">
                <td data-label="U≈ºytkownik">{{ log.user }}</td>
                <td data-label="Operacja">{{ log.operation }}</td>
                <td data-label="Produkt">{{ log.itemName }} (ID: {{ log.itemId }})</td>
                <td data-label="Data">{{ formatDate(log.timestamp) }}</td>
                <td data-label="Szczeg√≥≈Çy">{{ log.details }}</td>
              </tr>
            </tbody>
          </table>
          <div class="export-buttons">
            <button (click)="exportToExcel()">Eksportuj do Excel</button>
          </div>
        </div>
        <div class="reports-section">
          <h2>Raporty</h2>
          <div class="report-tabs">
            <button class="toggle-history" (click)="showReport('stock')">Stan magazynowy</button>
            <button class="toggle-history" (click)="showReport('movements')">Ruchy w okresie</button>
            <button class="toggle-history" (click)="showReport('popular')">Najpopularniejsze produkty</button>
          </div>
          <div *ngIf="currentReport === 'stock'" class="report-content">
            <h3>Stan magazynowy</h3>
            <table>
              <thead>
                <tr>
                  <th>Nazwa</th>
                  <th>Kod</th>
                  <th>Ilo≈õƒá</th>
                  <th>Kategoria</th>
                  <th>Lokalizacja</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of warehouseItems">
                  <td>{{ item.name }}</td>
                  <td>{{ item.code }}</td>
                  <td>{{ item.quantity }}</td>
                  <td>{{ item.category }}</td>
                  <td>{{ item.location }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div *ngIf="currentReport === 'movements'" class="report-content">
            <h3>Ruchy w okresie</h3>
            <form (ngSubmit)="loadMovementsInPeriod()" class="movement-filters">
              <div class="form-group">
                <label for="movementStartDate">Od</label>
                <input type="date" id="movementStartDate" [(ngModel)]="movementStartDate" name="startDate" required>
              </div>
              <div class="form-group">
                <label for="movementEndDate">Do</label>
                <input type="date" id="movementEndDate" [(ngModel)]="movementEndDate" name="endDate" required>
              </div>
              <button type="submit" class="add-button">Poka≈º ruchy</button>
            </form>
            <table *ngIf="movementsInPeriod.length > 0">
              <thead>
                <tr>
                  <th>Typ</th>
                  <th>Produkt</th>
                  <th>Ilo≈õƒá</th>
                  <th>Data</th>
                  <th>U≈ºytkownik</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let movement of movementsInPeriod">
                  <td>{{ movement.movementType }}</td>
                  <td>{{ movement.warehouseItemName }}</td>
                  <td>{{ movement.quantity }}</td>
                  <td>{{ formatDate(movement.date) }}</td>
                  <td>{{ movement.createdBy }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div *ngIf="currentReport === 'popular'" class="report-content">
            <h3>Najpopularniejsze produkty</h3>
            <table>
              <thead>
                <tr>
                  <th>Nazwa</th>
                  <th>Liczba wyda≈Ñ</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let product of popularProducts">
                  <td>{{ product.name }}</td>
                  <td>{{ product.issueCount }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>
