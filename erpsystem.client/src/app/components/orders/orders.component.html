<div class="orders-container">
  <div class="dashboard-container">
    <app-sidebar (navigate)="navigateTo($event)" (logoutEvent)="logout()"></app-sidebar>
    <main class="main-content">
      <header>
        <div>
          <h1>Zamówienia</h1>
          <p>Zarządzaj zamówieniami w systemie</p>
        </div>
        <div class="user-info">
          <p>Zalogowany jako: <strong>{{ currentUserEmail || 'Brak danych użytkownika' }}</strong></p>
        </div>
      </header>
      <section class="orders-section">
        <div class="messages">
          <div class="alert alert-success" *ngIf="successMessage">{{ successMessage }}</div>
          <div class="alert alert-danger" *ngIf="errorMessage">{{ errorMessage }}</div>
          <div class="notification" *ngIf="notificationMessage">
            {{ notificationMessage }}
            <button (click)="notificationMessage = null">Zamknij</button>
          </div>
        </div>
        <app-order-form *ngIf="showAddForm"
                        [contractors]="contractors"
                        [warehouseItems]="warehouseItems"
                        [orderTypes]="orderTypes"
                        (orderSaved)="onOrderSaved()"
                        (cancel)="toggleAddForm()"></app-order-form>
        <app-order-form *ngIf="showEditForm && selectedOrder"
                        [order]="selectedOrder"
                        [contractors]="contractors"
                        [warehouseItems]="warehouseItems"
                        [orderTypes]="orderTypes"
                        (orderSaved)="onOrderSaved()"
                        (cancel)="toggleEditForm(selectedOrder)"></app-order-form>
        <div class="orders-list">
          <div class="list-controls">
            <button class="add-button" (click)="toggleAddForm()">Dodaj zamówienie</button>
            <button class="export-button" (click)="exportToCsv()">Eksportuj do CSV</button>
          </div>
          <form [formGroup]="filterForm" class="advanced-filters">
            <input formControlName="nameFilter" placeholder="Szukaj po kontrahencie" (ngModelChange)="applyFilters()">
            <select formControlName="typeFilter" (ngModelChange)="applyFilters()">
              <option value="">Wszystkie typy</option>
              <option *ngFor="let type of orderTypes" [value]="type.value">{{ type.display }}</option>
            </select>
            <select formControlName="statusFilter" (ngModelChange)="applyFilters()">
              <option value="">Wszystkie statusy</option>
              <option *ngFor="let status of orderStatuses" [value]="status.value">{{ status.display }}</option>
            </select>
            <input type="date" formControlName="startDate" (ngModelChange)="applyFilters()">
            <input type="date" formControlName="endDate" (ngModelChange)="applyFilters()">
          </form>
          <table>
            <thead>
              <tr>
                <th>Numer</th>
                <th>Kontrahent</th>
                <th>Typ</th>
                <th>Data</th>
                <th>Kwota</th>
                <th>Status</th>
                <th class="actions-header">Akcje</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let order of filteredOrders; trackBy: trackByOrderId">
                <td data-label="Numer" (click)="showDetails(order)" class="clickable">{{ order.orderNumber }}</td>
                <td data-label="Kontrahent">{{ order.contractorName }}</td>
                <td data-label="Typ">{{ getTypeDisplay(order.orderType) }}</td>
                <td data-label="Data">{{ order.orderDate | date:'shortDate' }}</td>
                <td data-label="Kwota">{{ order.totalAmount | currency:'PLN' }}</td>
                <td data-label="Status">{{ getStatusDisplay(order.status) }}</td>
                <td data-label="Akcje" class="actions">
                  <div class="action-buttons">
                    <button *ngIf="order.status === 'Draft'" class="action-button edit-button" (click)="toggleEditForm(order)">Edytuj</button>
                    <button *ngIf="order.status === 'Draft'" class="action-button delete-button" (click)="confirmDelete(order.id)">Usuń</button>
                    <button *ngIf="order.status === 'Draft'" class="action-button confirm-button" (click)="confirmOrder(order.id)">Potwierdź</button>
                    <button *ngIf="['Confirmed', 'Completed'].includes(order.status)" class="action-button invoice-button" (click)="generateInvoice(order.id)" [disabled]="isGeneratingInvoice">Generuj fakturę</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="pagination" *ngIf="totalItems > pageSize">
            <button (click)="prevPage()" [disabled]="currentPage === 1">Poprzednia</button>
            <span>Strona {{ currentPage }} z {{ getTotalPages() }}</span>
            <button (click)="nextPage()" [disabled]="currentPage >= getTotalPages()">Następna</button>
          </div>
        </div>
        <div class="modal" *ngIf="selectedOrder">
          <div class="modal-content">
            <h3>Szczegóły zamówienia</h3>
            <p><strong>Numer:</strong> {{ selectedOrder.orderNumber }}</p>
            <p><strong>Kontrahent:</strong> {{ selectedOrder.contractorName }}</p>
            <p><strong>Typ:</strong> {{ getTypeDisplay(selectedOrder.orderType || '') }}</p>
            <p><strong>Data:</strong> {{ selectedOrder.orderDate | date:'shortDate' }}</p>
            <p><strong>Kwota:</strong> {{ selectedOrder.totalAmount | currency:'PLN' }}</p>
            <p><strong>Status:</strong> {{ getStatusDisplay(selectedOrder.status || '') }}</p>
            <h4>Produkty</h4>
            <table class="items-table">
              <thead>
                <tr>
                  <th>Produkt</th>
                  <th>Ilość</th>
                  <th>Cena jednostkowa</th>
                  <th>VAT</th>
                  <th>Razem</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of selectedOrder.orderItems">
                  <td data-label="Produkt">{{ item.warehouseItemName }}</td>
                  <td data-label="Ilość">{{ item.quantity }}</td>
                  <td data-label="Cena jednostkowa">{{ item.unitPrice | currency:'PLN' }}</td>
                  <td data-label="VAT">{{ item.vatRate }}%</td>
                  <td data-label="Razem">{{ item.totalPrice | currency:'PLN' }}</td>
                </tr>
              </tbody>
            </table>
            <h4>Historia zmian</h4>
            <table class="history-table">
              <thead>
                <tr>
                  <th>Akcja</th>
                  <th>Użytkownik</th>
                  <th>Data</th>
                  <th>Szczegóły</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let history of orderHistory">
                  <td>{{ history.action }}</td>
                  <td>{{ history.modifiedBy }}</td>
                  <td>{{ history.modifiedDate | date:'short' }}</td>
                  <td>{{ history.details }}</td>
                </tr>
              </tbody>
            </table>
            <button class="close-button" (click)="closeDetails()">Zamknij</button>
          </div>
        </div>
        <div class="modal" *ngIf="orderToDelete">
          <div class="modal-content">
            <h3>Potwierdź usunięcie</h3>
            <p>Czy na pewno chcesz usunąć to zamówienie?</p>
            <div class="form-buttons">
              <button class="delete-button" (click)="deleteOrder(orderToDelete!)">Tak</button>
              <button class="cancel-button" (click)="cancelDelete()">Nie</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>
