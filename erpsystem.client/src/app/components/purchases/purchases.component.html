<div class="purchases-container">
  <mat-spinner *ngIf="isLoading"></mat-spinner>
  <app-sidebar (navigate)="router.navigate([$event])"></app-sidebar>
  <div class="content">
    <div class="actions">
      <button class="action-button" (click)="loadData()" [disabled]="isLoading">Odśwież</button>
      <button class="action-button" (click)="showAddForm = !showAddForm">Dodaj</button>
      <button class="action-button" (click)="showDeleted = !showDeleted">{{ showDeleted ? 'Pokaż aktywne' : 'Pokaż usunięte' }}</button>
      <button class="action-button" [disabled]="!hasSelectedPurchases" (click)="deleteSelected()">Usuń wybrane</button>
      <input [(ngModel)]="nameFilterValue" placeholder="Szukaj po kontrahencie" (ngModelChange)="applyFilters()">
      <select [(ngModel)]="statusFilter" (ngModelChange)="applyFilters()">
        <option *ngFor="let status of purchaseStatuses" [value]="status.value">{{ status.display }}</option>
      </select>
      <input type="date" [(ngModel)]="startDate" (ngModelChange)="applyFilters()" placeholder="Od">
      <input type="date" [(ngModel)]="endDate" (ngModelChange)="applyFilters()" placeholder="Do">
    </div>

    <div *ngIf="contractors.length === 0 && !isLoading" class="no-contractors">
      <p>Brak dostępnych kontrahentów. Dodaj kontrahenta w sekcji zarządzania kontrahentami.</p>
    </div>

    <form [formGroup]="newPurchaseForm" *ngIf="showAddForm" (ngSubmit)="submitNewPurchase()">
      <div class="form-container">
        <h2>Dodaj zamówienie</h2>
        <div class="form-group">
          <label for="purchaseNumber">Numer zamówienia</label>
          <input id="purchaseNumber" formControlName="purchaseNumber" required>
        </div>
        <div class="form-group">
          <label for="contractorId">Kontrahent</label>
          <select id="contractorId" formControlName="contractorId" required>
            <option value="">Wybierz kontrahenta</option>
            <option *ngFor="let contractor of contractors" [value]="contractor.id">{{ contractor.name }}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="orderDate">Data zamówienia</label>
          <input id="orderDate" type="date" formControlName="orderDate" required>
        </div>
        <div class="form-group">
          <label for="createdBy">Utworzone przez</label>
          <input id="createdBy" formControlName="createdBy" readonly>
        </div>
        <div formArrayName="purchaseItems">
          <h3>Pozycje zamówienia</h3>
          <div *ngFor="let item of purchaseItems.controls; let i = index" [formGroupName]="i" class="purchase-item">
            <div class="form-group">
              <label for="warehouseItemId-{{i}}">Produkt</label>
              <input id="warehouseItemId-{{i}}" formControlName="warehouseItemId" required>
            </div>
            <div class="form-group">
              <label for="quantity-{{i}}">Ilość</label>
              <input id="quantity-{{i}}" type="number" formControlName="quantity" required>
            </div>
            <div class="form-group">
              <label for="unitPrice-{{i}}">Cena jednostkowa</label>
              <input id="unitPrice-{{i}}" type="number" formControlName="unitPrice" readonly [value]="item.get('unitPrice')?.value | currency:'PLN'">
            </div>
            <div class="form-group">
              <label for="vatRate-{{i}}">VAT (%)</label>
              <input id="vatRate-{{i}}" type="number" formControlName="vatRate" required>
            </div>
            <div class="form-group">
              <label for="totalPrice-{{i}}">Razem</label>
              <input id="totalPrice-{{i}}" type="number" formControlName="totalPrice" readonly [value]="item.get('totalPrice')?.value | currency:'PLN'">
            </div>
            <button type="button" class="action-button delete-button" (click)="removePurchaseItem(i)">Usuń</button>
          </div>
          <button type="button" class="action-button" (click)="addPurchaseItem()">Dodaj pozycję</button>
        </div>
        <div class="action-buttons">
          <button type="submit" class="action-button" [disabled]="newPurchaseForm.invalid || isLoading">Zapisz</button>
          <button type="button" class="action-button cancel-button" (click)="showAddForm = false">Anuluj</button>
        </div>
      </div>
    </form>

    <form [formGroup]="editPurchaseForm" (ngSubmit)="submitEditPurchase()" *ngIf="editPurchaseForm.value.id">
      <div class="form-container">
        <h2>Edytuj zamówienie</h2>
        <div class="form-group">
          <label for="editPurchaseNumber">Numer zamówienia</label>
          <input id="editPurchaseNumber" formControlName="purchaseNumber" required>
        </div>
        <div class="form-group">
          <label for="editContractorId">Kontrahent</label>
          <select id="editContractorId" formControlName="contractorId" required>
            <option value="">Wybierz kontrahenta</option>
            <option *ngFor="let contractor of contractors" [value]="contractor.id">{{ contractor.name }}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editOrderDate">Data zamówienia</label>
          <input id="editOrderDate" type="date" formControlName="orderDate" required>
        </div>
        <div class="form-group">
          <label for="editCreatedBy">Utworzone przez</label>
          <input id="editCreatedBy" formControlName="createdBy" readonly>
        </div>
        <div formArrayName="purchaseItems">
          <h3>Pozycje zamówienia</h3>
          <div *ngFor="let item of editPurchaseItems.controls; let i = index" [formGroupName]="i" class="purchase-item">
            <div class="form-group">
              <label for="editWarehouseItemId-{{i}}">Produkt</label>
              <input id="editWarehouseItemId-{{i}}" formControlName="warehouseItemId" required>
            </div>
            <div class="form-group">
              <label for="editQuantity-{{i}}">Ilość</label>
              <input id="editQuantity-{{i}}" type="number" formControlName="quantity" required>
            </div>
            <div class="form-group">
              <label for="editUnitPrice-{{i}}">Cena jednostkowa</label>
              <input id="editUnitPrice-{{i}}" type="number" formControlName="unitPrice" readonly [value]="item.get('unitPrice')?.value | currency:'PLN'">
            </div>
            <div class="form-group">
              <label for="editVatRate-{{i}}">VAT (%)</label>
              <input id="editVatRate-{{i}}" type="number" formControlName="vatRate" required>
            </div>
            <div class="form-group">
              <label for="editTotalPrice-{{i}}">Razem</label>
              <input id="editTotalPrice-{{i}}" type="number" formControlName="totalPrice" readonly [value]="item.get('totalPrice')?.value | currency:'PLN'">
            </div>
            <button type="button" class="action-button delete-button" (click)="removeEditPurchaseItem(i)">Usuń</button>
          </div>
          <button type="button" class="action-button" (click)="addEditPurchaseItem()">Dodaj pozycję</button>
        </div>
        <div class="action-buttons">
          <button type="submit" class="action-button" [disabled]="editPurchaseForm.invalid || isLoading">Zapisz</button>
          <button type="button" class="action-button cancel-button" (click)="editPurchaseForm.reset()">Anuluj</button>
        </div>
      </div>
    </form>

    <table>
      <thead>
        <tr>
          <th><input type="checkbox" [checked]="selectAll" (change)="toggleSelectAll($event)"></th>
          <th (click)="sortTable('purchaseNumber')">Numer <span *ngIf="sortColumn === 'purchaseNumber'" [class.asc]="sortDirection === 'asc'">▼</span></th>
          <th (click)="sortTable('contractorName')">Kontrahent <span *ngIf="sortColumn === 'contractorName'" [class.asc]="sortDirection === 'asc'">▼</span></th>
          <th (click)="sortTable('orderDate')">Data <span *ngIf="sortColumn === 'orderDate'" [class.asc]="sortDirection === 'asc'">▼</span></th>
          <th (click)="sortTable('totalAmount')">Kwota <span *ngIf="sortColumn === 'totalAmount'" [class.asc]="sortDirection === 'asc'">▼</span></th>
          <th (click)="sortTable('status')">Status <span *ngIf="sortColumn === 'status'" [class.asc]="sortDirection === 'asc'">▼</span></th>
          <th>Akcje</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let purchase of filteredPurchases | slice: (currentPage - 1) * pageSize : currentPage * pageSize">
          <td><input type="checkbox" [(ngModel)]="purchase.selected" (ngModelChange)="updateHasSelectedPurchases()"></td>
          <td data-label="Numer" (click)="showDetails(purchase)" class="clickable">{{ purchase.purchaseNumber }}</td>
          <td data-label="Kontrahent">{{ purchase.contractorName }}</td>
          <td data-label="Data">{{ purchase.orderDate | date:'shortDate' }}</td>
          <td data-label="Kwota">{{ purchase.totalAmount | currency:'PLN' }}</td>
          <td data-label="Status">{{ getStatusDisplay(purchase.status) }}</td>
          <td>
            <button *ngIf="!showDeleted && purchase.status === 'Draft'" class="action-button edit-button" (click)="startEdit(purchase)">Edytuj</button>
            <button *ngIf="!showDeleted && purchase.status === 'Draft'" class="action-button delete-button" (click)="confirmDelete(purchase.id)">Usuń</button>
            <button *ngIf="!showDeleted && purchase.status === 'Draft'" class="action-button confirm-button" (click)="confirmPurchase(purchase.id)">Potwierdź</button>
            <button *ngIf="!showDeleted && purchase.status === 'Confirmed'" class="action-button receive-button" (click)="receivePurchase(purchase.id)">Przyjmij</button>
            <button *ngIf="showDeleted" class="action-button restore-button" (click)="restorePurchase(purchase.id)">Przywróć</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="pagination" *ngIf="totalPages > 1">
      <button (click)="prevPage()" [disabled]="currentPage === 1">Poprzednia</button>
      <span>Strona {{ currentPage }} z {{ totalPages }}</span>
      <button (click)="nextPage()" [disabled]="currentPage === totalPages">Następna</button>
    </div>

    <div class="modal" *ngIf="selectedPurchase">
      <div class="modal-content">
        <h2>Szczegóły zamówienia</h2>
        <p><strong>Numer:</strong> {{ selectedPurchase.purchaseNumber }}</p>
        <p><strong>Kontrahent:</strong> {{ selectedPurchase.contractorName }}</p>
        <p><strong>Data:</strong> {{ selectedPurchase.orderDate | date:'shortDate' }}</p>
        <p><strong>Kwota:</strong> {{ selectedPurchase.totalAmount | currency:'PLN' }}</p>
        <p><strong>Status:</strong> {{ getStatusDisplay(selectedPurchase.status) }}</p>
        <div class="form-group">
          <label for="updateStatus">Zmień status</label>
          <select id="updateStatus" [(ngModel)]="selectedPurchase.status" (ngModelChange)="updateStatus(selectedPurchase)">
            <option *ngFor="let status of purchaseStatuses" [value]="status.value">{{ status.display }}</option>
          </select>
        </div>
        <h3>Pozycje zamówienia</h3>
        <table>
          <thead>
            <tr>
              <th>Produkt</th>
              <th>Ilość</th>
              <th>Cena jednostkowa</th>
              <th>VAT</th>
              <th>Razem</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of selectedPurchase.purchaseItems">
              <td data-label="Produkt">{{ item.warehouseItemName }}</td>
              <td data-label="Ilość">{{ item.quantity }}</td>
              <td data-label="Cena jednostkowa">{{ item.unitPrice | currency:'PLN' }}</td>
              <td data-label="VAT">{{ item.vatRate }}%</td>
              <td data-label="Razem">{{ item.totalPrice | currency:'PLN' }}</td>
            </tr>
          </tbody>
        </table>
        <h3>Historia zmian</h3>
        <table>
          <thead>
            <tr>
              <th>Akcja</th>
              <th>Zmodyfikowane przez</th>
              <th>Data</th>
              <th>Szczegóły</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let history of purchaseHistory">
              <td>{{ history.action }}</td>
              <td>{{ history.modifiedBy }}</td>
              <td>{{ history.modifiedDate | date:'short' }}</td>
              <td>{{ history.details }}</td>
            </tr>
          </tbody>
        </table>
        <button class="action-button close-button" (click)="closeDetails()">Zamknij</button>
      </div>
    </div>

    <div class="modal" *ngIf="purchaseToDelete">
      <div class="modal-content">
        <h2>Potwierdź usunięcie</h2>
        <p>Czy na pewno chcesz usunąć to zamówienie?</p>
        <button class="action-button delete-button" (click)="deletePurchase(purchaseToDelete)">Tak</button>
        <button class="action-button cancel-button" (click)="cancelDelete()">Nie</button>
      </div>
    </div>
  </div>
</div>
